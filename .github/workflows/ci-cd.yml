name: CI/CD - Build & Push Docker

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    # NOTE : Nous gardons 'packages: write' par précaution,
    # mais le login utilisera le PAT manuel qui est plus puissant.
    permissions:
      contents: read
      packages: write

    runs-on: ubuntu-latest

    steps:
      # 1️⃣ Checkout du code
      - name: Checkout du code
        uses: actions/checkout@v3

      # 2️⃣ Installer Java 17
      - name: Setup JDK 17
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '17'

      # 3️⃣ Build Maven dans le dossier api
      - name: Build Maven
        working-directory: src/api
        run: mvn clean package -DskipTests

      # 4️⃣ Login GHCR (Retour au PAT manuel pour la création initiale)
      - name: Login to GHCR (GitHub Container Registry)
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          # L'authentification utilise la casse correcte (Yanni-b) via github.actor
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_TOKEN }}

      # 5️⃣ Build Docker (contexte = src/api)
      - name: Build Docker image
        id: docker_build
        run: |
          # CORRECTION CLÉ : Utilisation du nom d'utilisateur statique en minuscules (yanni-b)
          # pour satisfaire l'exigence du tag Docker.
          IMAGE_NAME=ghcr.io/yanni-b/tp4maintenancelogiciel
          COMMIT_TAG=$(git rev-parse --short HEAD)
          
          # Ajoute les tags pour le build
          echo "IMAGE_NAME=$IMAGE_NAME" >> $GITHUB_OUTPUT
          echo "COMMIT_TAG=$COMMIT_TAG" >> $GITHUB_OUTPUT
          
          # Construction de l'image
          docker build -t $IMAGE_NAME:$COMMIT_TAG src/api

      # 6️⃣ Push Docker
      - name: Push Docker image
        # Utilise les variables de l'étape précédente
        run: |
          docker push ${{ steps.docker_build.outputs.IMAGE_NAME }}:${{ steps.docker_build.outputs.COMMIT_TAG }}